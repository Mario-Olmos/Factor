<!-- Popup de notificación -->
<app-pop-up 
  *ngIf="popupMessage" 
  [message]="popupMessage" 
  [type]="popupType" 
  (closed)="onPopUpClosed()">
</app-pop-up>

<div class="container">
  <h2 class="text-center mb-4">Subir un Nuevo Artículo</h2>
  <form (ngSubmit)="onSubmit()" [formGroup]="articleForm" enctype="multipart/form-data">

    <!-- Título -->
    <div class="form-group mb-3">
      <label for="title">Título</label>
      <input 
        type="text" 
        id="title" 
        formControlName="title" 
        class="form-control" 
        placeholder="Título del artículo"
        required 
        aria-describedby="titleHelp" />
      <small id="titleHelp" class="form-text text-muted">
        Máximo 100 caracteres.
      </small>
      <div *ngIf="articleForm.get('title')?.invalid && articleForm.get('title')?.touched" class="error">
        <small *ngIf="articleForm.get('title')?.errors?.required">El título es requerido.</small>
        <small *ngIf="articleForm.get('title')?.errors?.maxlength">El título no puede exceder 100 caracteres.</small>
      </div>
    </div>

    <!-- Descripción -->
    <div class="form-group mb-3">
      <label for="description">Descripción</label>
      <textarea 
        id="description" 
        formControlName="description" 
        class="form-control"
        placeholder="Descripción del artículo" 
        rows="6"
        aria-describedby="descriptionHelp">
      </textarea>
      <small id="descriptionHelp" class="form-text text-muted">
        Máximo 1000 caracteres.
      </small>
      <div *ngIf="articleForm.get('description')?.invalid && articleForm.get('description')?.touched" class="error">
        <small *ngIf="articleForm.get('description')?.errors?.maxlength">La descripción no puede exceder 1000 caracteres.</small>
      </div>
    </div>

    <!-- Fuente -->
    <div class="form-group mb-3">
      <label for="source">Fuente</label>
      <input 
        type="text" 
        id="source" 
        formControlName="source" 
        class="form-control" 
        placeholder="Fuente del artículo"
        required 
        aria-describedby="sourceHelp" />
      <small id="sourceHelp" class="form-text text-muted">
        Máximo 200 caracteres.
      </small>
      <div *ngIf="articleForm.get('source')?.invalid && articleForm.get('source')?.touched" class="error">
        <small *ngIf="articleForm.get('source')?.errors?.required">La fuente es requerida.</small>
        <small *ngIf="articleForm.get('source')?.errors?.maxlength">La fuente no puede exceder 200 caracteres.</small>
      </div>
    </div>

    <!-- Tema -->
    <div class="form-group mb-3">
      <label for="theme">Tema</label>
      <select 
        id="theme" 
        class="form-control" 
        formControlName="theme" 
        required 
        aria-describedby="themeHelp">
        <option value="" disabled selected>Seleccione una temática</option>

        <!-- Primer nivel -->
        <ng-container *ngFor="let theme of themes">
          <option [disabled]="true" class="theme-dd-level1">
            {{ theme.name }}
          </option>

          <!-- Segundo nivel -->
          <ng-container *ngFor="let subtheme of theme.subthemes">
            <option [disabled]="true" class="theme-dd-level2">
              &nbsp;&nbsp;{{ subtheme.name }}
            </option>

            <!-- Tercer nivel -->
            <ng-container *ngFor="let subSubtheme of subtheme.subthemes">
              <option [value]="subSubtheme._id" class="theme-dd-level3">
                &nbsp;&nbsp;&nbsp;&nbsp;• {{ subSubtheme.name }}
              </option>
            </ng-container>
          </ng-container>
        </ng-container>
      </select>
      <small id="themeHelp" class="form-text text-muted">
        Selecciona una temática para el artículo.
      </small>
      <div *ngIf="articleForm.get('theme')?.invalid && articleForm.get('theme')?.touched" class="error">
        <small>La temática es requerida.</small>
      </div>
    </div>

    <!-- PDF -->
    <div class="form-group mb-3">
      <label for="pdf">Archivo PDF</label>
      <input 
        type="file" 
        id="pdf" 
        (change)="onFileChange($event)" 
        class="form-control" 
        accept="application/pdf" 
        required 
        aria-describedby="pdfHelp" />
      <small id="pdfHelp" class="form-text text-muted">
        Selecciona un archivo en formato PDF.
      </small>
      <div *ngIf="pdfError" class="error">
        <small>Por favor, selecciona un archivo PDF válido.</small>
      </div>
    </div>

    <!-- Vista previa del archivo PDF seleccionado -->
    <div *ngIf="pdfFileName" class="mb-3">
      <p>Archivo seleccionado: {{ pdfFileName }}</p>
    </div>

    <!-- Imagen (opcional) -->
    <div class="form-group mb-3">
      <label for="image">Imagen de Perfil (opcional)</label>
      <input 
        type="file" 
        id="image" 
        (change)="onImageChange($event)" 
        class="form-control" 
        accept="image/jpeg, image/png" 
        aria-describedby="imageHelp" />
      <small id="imageHelp" class="form-text text-muted">
        Selecciona una imagen en formato JPEG o PNG.
      </small>
      <div *ngIf="!selectedFile && articleForm.get('image')?.touched && articleForm.get('image')?.invalid" class="error">
        <small>Por favor, selecciona una imagen válida.</small>
      </div>
    </div>

    <!-- Vista previa de la imagen seleccionada -->
    <div *ngIf="selectedFile" class="mb-3">
      <p>Imagen seleccionada: {{ selectedFile.name }}</p>
    </div>

    <!-- Botón de envío con indicador de carga -->
    <button 
      type="submit" 
      class="button" 
      [disabled]="articleForm.invalid || !pdfFile || loading">
      <span *ngIf="!loading">Subir Artículo</span>
      <span *ngIf="loading">Subiendo...</span>
    </button>

  </form>
</div>
